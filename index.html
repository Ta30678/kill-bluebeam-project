<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç‰†é‡è¨ˆç®—å·¥å…· - Wall Quantity Calculator</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Microsoft JhengHei", sans-serif;
        background: #f5f5f5;
        color: #333;
        height: 100vh;
        overflow: hidden;
      }

      /* ==================== ä¸»å®¹å™¨ ==================== */
      .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        max-width: 1600px;
        margin: 0 auto;
        background: #fff;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }

      /* ==================== é ‚éƒ¨æ¨™é¡Œå€ ==================== */
      .header {
        padding: 20px 30px;
        border-bottom: 3px solid #f5a623;
      }

      .header h1 {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
      }

      .header h1::after {
        content: "";
        display: block;
        width: 60px;
        height: 3px;
        background: #f5a623;
        margin-top: 8px;
      }

      /* ==================== æ“ä½œæŒ‰éˆ•å€ ==================== */
      .action-bar {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #f5a623;
        color: white;
      }

      .btn-primary:hover {
        background: #e6951a;
      }

      .btn-secondary {
        background: #9e9e9e;
        color: white;
      }

      .btn-secondary:hover {
        background: #757575;
      }

      .btn-outline {
        background: white;
        color: #666;
        border: 1px solid #ddd;
      }

      .btn-outline:hover {
        background: #f5f5f5;
        border-color: #ccc;
      }

      .btn-success {
        background: #4caf50;
        color: white;
      }

      .btn-success:hover {
        background: #43a047;
      }

      .btn-info {
        background: #2196f3;
        color: white;
      }

      .btn-info:hover {
        background: #1e88e5;
      }

      .file-status {
        font-size: 13px;
        color: #888;
        margin-left: 10px;
      }

      /* ==================== ç¯©é¸å™¨èˆ‡å·¥å…·åˆ— ==================== */
      .toolbar-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 30px;
        background: #fafafa;
        border-bottom: 1px solid #eee;
      }

      .filters {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .filter-label {
        font-size: 14px;
        color: #666;
      }

      .filter-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        min-width: 120px;
        background: white;
        cursor: pointer;
      }

      .filter-select:focus {
        outline: none;
        border-color: #f5a623;
      }

      .filter-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        width: 80px;
        text-align: center;
      }

      .tools {
        display: flex;
        gap: 10px;
      }

      .tool-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .tool-btn-grid {
        background: #4caf50;
        color: white;
      }

      .tool-btn-grid:hover {
        background: #43a047;
      }

      .tool-btn-search {
        background: #2196f3;
        color: white;
      }

      .tool-btn-search:hover {
        background: #1e88e5;
      }

      .tool-btn-fullscreen {
        background: #f5a623;
        color: white;
      }

      .tool-btn-fullscreen:hover {
        background: #e6951a;
      }

      /* ==================== ä¸»å…§å®¹å€ ==================== */
      .main-content {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      /* å·¦å´é¢æ¿ - å¯æ‘ºç–Šåœ–å±¤åˆ—è¡¨ */
      .sidebar-left {
        position: relative;
        width: 200px;
        min-width: 40px;
        background: #f9f9f9;
        border-right: 1px solid #eee;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: width 0.3s ease;
      }

      .sidebar-left.collapsed {
        width: 40px;
      }

      .sidebar-toggle {
        position: absolute;
        top: 50%;
        right: -12px;
        transform: translateY(-50%);
        z-index: 10;
        width: 24px;
        height: 48px;
        background: #f5a623;
        border: none;
        border-radius: 0 6px 6px 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        transition: background 0.2s;
      }

      .sidebar-toggle:hover {
        background: #e6951a;
      }

      .sidebar-left.collapsed .sidebar-toggle {
        right: -12px;
      }

      .sidebar-left.collapsed .toggle-icon {
        transform: rotate(180deg);
      }

      .toggle-icon {
        transition: transform 0.3s ease;
      }

      .sidebar-content {
        flex: 1;
        overflow: hidden;
        transition: opacity 0.3s ease;
      }

      .sidebar-left.collapsed .sidebar-content {
        opacity: 0;
        pointer-events: none;
      }

      .sidebar-section {
        border-bottom: 1px solid #eee;
      }

      .sidebar-header {
        padding: 12px 15px;
        background: #f0f0f0;
        font-weight: 600;
        font-size: 13px;
        color: #555;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .sidebar-body {
        padding: 10px;
        max-height: 200px;
        overflow-y: auto;
      }

      .tree-item {
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 13px;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .tree-item:hover {
        background: #e8e8e8;
      }

      .tree-item.selected {
        background: #fff3e0;
        color: #f5a623;
        font-weight: 500;
      }

      .tree-item .icon {
        font-size: 12px;
      }

      /* ç•«å¸ƒå®¹å™¨ */
      .canvas-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .canvas-header {
        padding: 10px 20px;
        background: #fff;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .canvas-title {
        font-size: 14px;
        color: #666;
      }

      .canvas-tools {
        display: flex;
        gap: 5px;
      }

      .canvas-tool-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s;
      }

      .canvas-tool-btn:hover {
        background: #f5f5f5;
        border-color: #ccc;
      }

      .canvas-tool-btn.active {
        background: #f5a623;
        color: white;
        border-color: #f5a623;
      }

      .canvas-container {
        flex: 1;
        position: relative;
        overflow: hidden;
        background: #fff;
        border: 1px solid #eee;
        margin: 10px;
        border-radius: 4px;
      }

      #mainCanvas {
        position: absolute;
        top: 0;
        left: 0;
        /* é˜²æ­¢ä¸­éµé»æ“Šæ™‚å‡ºç¾è‡ªå‹•æ»¾å‹•åœ–æ¨™ */
        overflow: hidden;
        /* ç¦ç”¨æ–‡å­—é¸å–ä»¥é¿å…æ‹–æ›³æ™‚é¸åˆ°æ–‡å­— */
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      /* ç•«å¸ƒæ‹–æ›³ä¸­ç‹€æ…‹ */
      #mainCanvas.panning {
        cursor: grabbing !important;
      }

      /* ç•«å¸ƒå®¹å™¨é˜²æ­¢è‡ªå‹•æ»¾å‹• */
      .canvas-container {
        overflow: hidden;
        /* é˜²æ­¢ä¸­éµè‡ªå‹•æ»¾å‹•åŠŸèƒ½ */
        overflow-anchor: none;
      }

      .help-icon {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 24px;
        height: 24px;
        background: #2196f3;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        cursor: help;
      }

      /* å³å´é¢æ¿ - å±¬æ€§/çµ±è¨ˆ */
      .sidebar-right {
        width: 280px;
        background: #f9f9f9;
        border-left: 1px solid #eee;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .panel-tabs {
        display: flex;
        border-bottom: 1px solid #eee;
      }

      .panel-tab {
        flex: 1;
        padding: 12px;
        text-align: center;
        font-size: 13px;
        cursor: pointer;
        background: #f0f0f0;
        border: none;
        transition: all 0.2s;
      }

      .panel-tab:hover {
        background: #e8e8e8;
      }

      .panel-tab.active {
        background: white;
        font-weight: 600;
        color: #f5a623;
        border-bottom: 2px solid #f5a623;
      }

      .panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
      }

      .property-group {
        margin-bottom: 15px;
      }

      .property-label {
        font-size: 12px;
        color: #888;
        margin-bottom: 4px;
      }

      .property-value {
        font-size: 14px;
        padding: 8px 12px;
        background: white;
        border: 1px solid #eee;
        border-radius: 4px;
      }

      select.property-value {
        width: 100%;
        cursor: pointer;
      }

      /* é¡å‹åˆ—è¡¨ */
      .category-list {
        list-style: none;
      }

      .category-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        background: white;
        border: 1px solid #eee;
        border-radius: 4px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .category-item:hover {
        border-color: #f5a623;
      }

      .category-item.selected {
        border-color: #f5a623;
        background: #fff8e1;
      }

      .category-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        margin-right: 10px;
      }

      .category-info {
        flex: 1;
      }

      .category-name {
        font-size: 13px;
        font-weight: 500;
      }

      .category-stats {
        font-size: 11px;
        color: #888;
        margin-top: 2px;
      }

      /* çµ±è¨ˆè¡¨ */
      .summary-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .summary-table th,
      .summary-table td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .summary-table th {
        background: #f5f5f5;
        font-weight: 600;
        color: #666;
      }

      .summary-table tr:hover {
        background: #fafafa;
      }

      .summary-total {
        background: #fff8e1 !important;
        font-weight: 600;
      }

      /* ==================== ç‹€æ…‹åˆ— ==================== */
      .statusbar {
        padding: 8px 30px;
        background: #f5f5f5;
        border-top: 1px solid #eee;
        font-size: 12px;
        color: #666;
        display: flex;
        justify-content: space-between;
      }

      /* ==================== Modal å°è©±æ¡† ==================== */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: white;
        border-radius: 8px;
        width: 500px;
        max-width: 90%;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-20px);
        transition: transform 0.3s;
      }

      .modal-overlay.show .modal {
        transform: translateY(0);
      }

      .modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 16px;
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #888;
        line-height: 1;
      }

      .modal-close:hover {
        color: #333;
      }

      .modal-body {
        padding: 20px;
        overflow-y: auto;
        max-height: 60vh;
      }

      .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-label {
        display: block;
        font-size: 13px;
        color: #666;
        margin-bottom: 6px;
      }

      .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .form-input:focus {
        outline: none;
        border-color: #f5a623;
      }

      /* ==================== è¼‰å…¥èˆ‡é€šçŸ¥ ==================== */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #eee;
        border-top-color: #f5a623;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .loading-text {
        margin-top: 15px;
        font-size: 14px;
        color: #666;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .notification {
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 15px 20px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .notification.show {
        transform: translateY(0);
        opacity: 1;
      }

      .notification.success {
        border-left: 4px solid #4caf50;
      }

      .notification.error {
        border-left: 4px solid #f44336;
      }

      .notification.info {
        border-left: 4px solid #2196f3;
      }

      /* éš±è—æª”æ¡ˆè¼¸å…¥ */
      #fileInput {
        display: none;
      }

      /* ç©ºç‹€æ…‹ */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #888;
      }

      .empty-state .icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <!-- è¼‰å…¥å‹•ç•« -->
    <div class="loading-overlay" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">è™•ç†ä¸­...</div>
    </div>

    <!-- é€šçŸ¥è¨Šæ¯ -->
    <div class="notification" id="notification"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="app-container">
      <!-- é ‚éƒ¨æ¨™é¡Œå€ -->
      <header class="header">
        <h1>ç‰†é‡è¨ˆç®—å·¥å…·</h1>
        <div class="action-bar">
          <button class="btn btn-primary" id="uploadBtn">
            <span>ğŸ“</span> ä¸Šå‚³ DXF æª”æ¡ˆ
          </button>
          <span class="file-status" id="fileStatus">æœªé¸æ“‡æª”æ¡ˆ</span>

          <div style="flex: 1"></div>

          <button
            class="btn btn-success"
            id="selectLayersBtn"
            disabled
            style="display: none"
          >
            <span>ğŸ“‹</span> é¸æ“‡è¨ˆç®—åœ–å±¤
          </button>
          <button
            class="btn btn-secondary"
            id="exportCsvBtn"
            disabled
            style="display: none"
          >
            <span>ğŸ“„</span> åŒ¯å‡º CSV
          </button>
        </div>
        <input type="file" id="fileInput" accept=".dxf" />
      </header>

      <!-- ç¯©é¸å™¨èˆ‡å·¥å…·åˆ— -->
      <div class="toolbar-row">
        <div class="filters">
          <div class="filter-group" style="display: none">
            <span class="filter-label">æ£Ÿ</span>
            <select class="filter-select" id="buildingFilter">
              <option value="">å…¨éƒ¨</option>
            </select>
          </div>
          <div class="filter-group" style="display: none">
            <span class="filter-label">æ¨“å±¤</span>
            <select class="filter-select" id="floorFilter">
              <option value="">å…¨éƒ¨</option>
            </select>
          </div>
          <div class="filter-group" style="display: none">
            <span class="filter-label">é¡å‹</span>
            <select class="filter-select" id="categoryFilter">
              <option value="">å…¨éƒ¨</option>
            </select>
          </div>
        </div>
        <div class="tools">
          <span id="infoText" style="color: #666; font-size: 14px"
            >ç­‰å¾…ä¸Šå‚³ DXF æª”æ¡ˆ...</span
          >
        </div>
      </div>

      <!-- ä¸»å…§å®¹å€ -->
      <div class="main-content">
        <!-- å·¦å´é¢æ¿ - åœ–å±¤åˆ—è¡¨ -->
        <aside class="sidebar-left" id="sidebarLeft">
          <!-- æ‘ºç–Šåˆ‡æ›æŒ‰éˆ• -->
          <button class="sidebar-toggle" id="sidebarToggle" title="å±•é–‹/æ”¶åˆåœ–å±¤åˆ—è¡¨">
            <span class="toggle-icon">â—€</span>
          </button>
          <div class="sidebar-content" id="sidebarContent" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
            <div class="sidebar-section" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
              <div class="sidebar-header">
                <span>ğŸ“‹ åœ–å±¤åˆ—è¡¨</span>
                <span id="layerCount" style="font-size: 11px; color: #888">0 å€‹åœ–å±¤</span>
              </div>
              <div
                class="sidebar-body"
                id="layerList"
                style="flex: 1; overflow-y: auto;"
              >
                <div class="empty-state" style="padding: 20px">
                  <div style="font-size: 12px">è«‹å…ˆä¸Šå‚³ DXF æª”æ¡ˆ</div>
                </div>
              </div>
            </div>
          </div>
        </aside>

        <!-- ç•«å¸ƒå€åŸŸ -->
        <div class="canvas-area">
          <div class="canvas-header">
            <span class="canvas-title" id="canvasTitle"
              >çµæ§‹å¹³é¢åœ– (æ‰€æœ‰æ¨“å±¤åˆä½µ)</span
            >
            <div class="canvas-tools">
              <button
                class="canvas-tool-btn active"
                data-tool="select"
                title="é¸å–"
              >
                â¬š
              </button>
              <button class="canvas-tool-btn" data-tool="pan" title="å¹³ç§»">
                âœ‹
              </button>
              <button class="canvas-tool-btn" data-tool="zoom-in" title="æ”¾å¤§">
                ğŸ”+
              </button>
              <button class="canvas-tool-btn" data-tool="zoom-out" title="ç¸®å°">
                ğŸ”-
              </button>
              <button class="canvas-tool-btn" data-tool="fit" title="é©åˆè¦–çª—">
                â›¶
              </button>
            </div>
          </div>
          <div class="canvas-container" id="canvasContainer">
            <canvas id="mainCanvas"></canvas>
            <div class="help-icon" title="æ“ä½œèªªæ˜ï¼š\n- æ»¾è¼ªï¼šç¸®æ”¾ç•«å¸ƒ\n- Shift+æ»¾è¼ªï¼šå·¦å³ç§»å‹•ç•«å¸ƒ\n- ä¸­éµæ‹–æ›³ï¼šè‡ªç”±å¹³ç§»ç•«å¸ƒ\n- å³éµæ‹–æ›³ï¼šå¹³ç§»ç•«å¸ƒ\n- å·¦éµé»æ“Šï¼šé¸å–ç·šæ®µ\n- Shift+å·¦éµï¼šå¤šé¸ç·šæ®µ\n- ESCï¼šå–æ¶ˆé¸å–">?</div>
          </div>
        </div>

        <!-- å³å´é¢æ¿ - çµ±è¨ˆè³‡è¨Š -->
        <aside class="sidebar-right">
          <div class="panel-tabs">
            <button class="panel-tab active" data-panel="summary">çµ±è¨ˆ</button>
          </div>
          <div class="panel-content" id="panelContent">
            <div id="summaryPanel">
              <div style="margin-bottom: 15px">
                <strong>æª”æ¡ˆè³‡è¨Š</strong>
              </div>
              <div class="property-group">
                <div class="property-label">æª”æ¡ˆåç¨±</div>
                <div class="property-value" id="fileName">-</div>
              </div>
              <div class="property-group">
                <div class="property-label">åœ–å±¤æ•¸é‡</div>
                <div class="property-value" id="layerCountInfo">-</div>
              </div>
              <div class="property-group">
                <div class="property-label">ç·šæ®µç¸½æ•¸</div>
                <div class="property-value" id="segmentCountInfo">-</div>
              </div>
              <div style="margin: 20px 0; border-top: 1px solid #eee"></div>
              <div style="margin-bottom: 15px">
                <strong>åœ–å±¤çµ±è¨ˆ</strong>
              </div>
              <table class="summary-table" id="summaryTable">
                <thead>
                  <tr>
                    <th>åœ–å±¤</th>
                    <th>ç·šæ®µæ•¸</th>
                    <th>é•·åº¦(m)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="3" class="empty-state">å°šç„¡è³‡æ–™</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </aside>
      </div>

      <!-- ç‹€æ…‹åˆ— -->
      <footer class="statusbar">
        <span id="statusLeft">æº–å‚™å°±ç·’ - è«‹ä¸Šå‚³ DXF æª”æ¡ˆé–‹å§‹</span>
        <span id="statusRight">åº§æ¨™: 0, 0 | ç¸®æ”¾: 100%</span>
      </footer>
    </div>

    <!-- æ–°å¢ç‰†é¡å‹å°è©±æ¡† -->
    <div class="modal-overlay" id="categoryModal">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title">è¨­å®šç‰†é¡å‹</span>
          <button class="modal-close" onclick="closeCategoryModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div id="categoryFormList">
            <!-- å‹•æ…‹ç”Ÿæˆé¡å‹è¡¨å–® -->
          </div>
          <button
            class="btn btn-outline"
            style="width: 100%; margin-top: 10px"
            onclick="addCategoryRow()"
          >
            + æ–°å¢é¡å‹
          </button>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeCategoryModal()">
            å–æ¶ˆ
          </button>
          <button class="btn btn-primary" onclick="saveCategories()">
            å„²å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- æ–°å¢æ£Ÿ/æ¨“å±¤å°è©±æ¡† -->
    <div class="modal-overlay" id="structureModal">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title" id="structureModalTitle">æ–°å¢çµæ§‹ç‰©</span>
          <button class="modal-close" onclick="closeStructureModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">åç¨±</label>
            <input
              type="text"
              class="form-input"
              id="structureName"
              placeholder="ä¾‹å¦‚ï¼šAæ£Ÿã€B1F"
            />
          </div>
          <div class="form-group" id="floorRangeGroup" style="display: none">
            <label class="form-label">æ¨“å±¤ç¯„åœï¼ˆé¸å¡«ï¼‰</label>
            <input
              type="text"
              class="form-input"
              id="floorRange"
              placeholder="ä¾‹å¦‚ï¼š7~8F"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeStructureModal()">
            å–æ¶ˆ
          </button>
          <button class="btn btn-primary" onclick="saveStructure()">
            æ–°å¢
          </button>
        </div>
      </div>
    </div>

    <script>
      // ==================== å…¨åŸŸç‹€æ…‹ ====================
      const state = {
        projectId: null,
        segments: [],
        categories: [],
        buildings: [],
        floors: [],
        selectedSegments: [],
        selectedBuilding: null,
        selectedFloor: null,
        currentTool: "select",
        zoom: 1,
        panX: 0,
        panY: 0,
        isDragging: false,
        dragStart: { x: 0, y: 0 },
        showGrid: true,
        structureModalMode: "building", // 'building' or 'floor'
        // æ–°å¢ï¼šæ»‘é¼ ä¸­éµæ‹–æ›³å¹³ç§»ç‹€æ…‹
        isMiddleMousePanning: false,
        middleMouseStart: { x: 0, y: 0, panX: 0, panY: 0 },
        // æ–°å¢ï¼šåœ–å±¤é¡è‰²å°æ‡‰è¡¨
        layerColors: {},
        // æ–°å¢ï¼šåœ–å±¤å¯è¦‹æ€§ç‹€æ…‹ (true = é¡¯ç¤º, false = éš±è—)
        layerVisibility: {},
      };

      // AutoCAD Color Index (ACI) è½‰ RGB é¡è‰²è¡¨
      // é€™æ˜¯ AutoCAD æ¨™æº–çš„ 256 è‰²èª¿è‰²ç›¤
      const ACI_COLORS = {
        0: '#000000',   // ByBlock
        1: '#FF0000',   // ç´…è‰²
        2: '#FFFF00',   // é»ƒè‰²
        3: '#00FF00',   // ç¶ è‰²
        4: '#00FFFF',   // é’è‰²
        5: '#0000FF',   // è—è‰²
        6: '#FF00FF',   // æ´‹ç´…è‰²
        7: '#FFFFFF',   // ç™½è‰²/é»‘è‰² (ä¾èƒŒæ™¯)
        8: '#808080',   // æ·±ç°è‰²
        9: '#C0C0C0',   // æ·ºç°è‰²
        10: '#FF0000', 11: '#FF7F7F', 12: '#CC0000', 13: '#CC6666', 14: '#990000', 15: '#994C4C',
        16: '#7F0000', 17: '#7F3F3F', 18: '#4C0000', 19: '#4C2626', 20: '#FF3F00', 21: '#FF9F7F',
        22: '#CC3200', 23: '#CC7F66', 24: '#992600', 25: '#995F4C', 26: '#7F1F00', 27: '#7F4F3F',
        28: '#4C1300', 28: '#4C2F26', 30: '#FF7F00', 31: '#FFBF7F', 32: '#CC6600', 33: '#CC9966',
        34: '#994C00', 35: '#99724C', 36: '#7F3F00', 37: '#7F5F3F', 38: '#4C2600', 39: '#4C3926',
        40: '#FFBF00', 41: '#FFDF7F', 42: '#CC9900', 43: '#CCB266', 44: '#997200', 45: '#99854C',
        46: '#7F5F00', 47: '#7F6F3F', 48: '#4C3900', 49: '#4C4226', 50: '#FFFF00', 51: '#FFFF7F',
        52: '#CCCC00', 53: '#CCCC66', 54: '#999900', 55: '#99994C', 56: '#7F7F00', 57: '#7F7F3F',
        58: '#4C4C00', 59: '#4C4C26', 60: '#BFFF00', 61: '#DFFF7F', 62: '#99CC00', 63: '#B2CC66',
        64: '#729900', 65: '#85994C', 66: '#5F7F00', 67: '#6F7F3F', 68: '#394C00', 69: '#424C26',
        70: '#7FFF00', 71: '#BFFF7F', 72: '#66CC00', 73: '#99CC66', 74: '#4C9900', 75: '#72994C',
        76: '#3F7F00', 77: '#5F7F3F', 78: '#264C00', 79: '#394C26', 80: '#3FFF00', 81: '#9FFF7F',
        82: '#32CC00', 83: '#7FCC66', 84: '#269900', 85: '#5F994C', 86: '#1F7F00', 87: '#4F7F3F',
        88: '#134C00', 89: '#2F4C26', 90: '#00FF00', 91: '#7FFF7F', 92: '#00CC00', 93: '#66CC66',
        94: '#009900', 95: '#4C994C', 96: '#007F00', 97: '#3F7F3F', 98: '#004C00', 99: '#264C26',
        100: '#00FF3F', 101: '#7FFF9F', 102: '#00CC32', 103: '#66CC7F', 104: '#009926', 105: '#4C995F',
        106: '#007F1F', 107: '#3F7F4F', 108: '#004C13', 109: '#264C2F', 110: '#00FF7F', 111: '#7FFFBF',
        112: '#00CC66', 113: '#66CC99', 114: '#00994C', 115: '#4C9972', 116: '#007F3F', 117: '#3F7F5F',
        118: '#004C26', 119: '#264C39', 120: '#00FFBF', 121: '#7FFFDF', 122: '#00CC99', 123: '#66CCB2',
        124: '#009972', 125: '#4C9985', 126: '#007F5F', 127: '#3F7F6F', 128: '#004C39', 129: '#264C42',
        130: '#00FFFF', 131: '#7FFFFF', 132: '#00CCCC', 133: '#66CCCC', 134: '#009999', 135: '#4C9999',
        136: '#007F7F', 137: '#3F7F7F', 138: '#004C4C', 139: '#264C4C', 140: '#00BFFF', 141: '#7FDFFF',
        142: '#0099CC', 143: '#66B2CC', 144: '#007299', 145: '#4C8599', 146: '#005F7F', 147: '#3F6F7F',
        148: '#00394C', 149: '#26424C', 150: '#007FFF', 151: '#7FBFFF', 152: '#0066CC', 153: '#6699CC',
        154: '#004C99', 155: '#4C7299', 156: '#003F7F', 157: '#3F5F7F', 158: '#00264C', 159: '#26394C',
        160: '#003FFF', 161: '#7F9FFF', 162: '#0032CC', 163: '#667FCC', 164: '#002699', 165: '#4C5F99',
        166: '#001F7F', 167: '#3F4F7F', 168: '#00134C', 169: '#262F4C', 170: '#0000FF', 171: '#7F7FFF',
        172: '#0000CC', 173: '#6666CC', 174: '#000099', 175: '#4C4C99', 176: '#00007F', 177: '#3F3F7F',
        178: '#00004C', 179: '#26264C', 180: '#3F00FF', 181: '#9F7FFF', 182: '#3200CC', 183: '#7F66CC',
        184: '#260099', 185: '#5F4C99', 186: '#1F007F', 187: '#4F3F7F', 188: '#13004C', 189: '#2F264C',
        190: '#7F00FF', 191: '#BF7FFF', 192: '#6600CC', 193: '#9966CC', 194: '#4C0099', 195: '#724C99',
        196: '#3F007F', 197: '#5F3F7F', 198: '#26004C', 199: '#39264C', 200: '#BF00FF', 201: '#DF7FFF',
        202: '#9900CC', 203: '#B266CC', 204: '#720099', 205: '#854C99', 206: '#5F007F', 207: '#6F3F7F',
        208: '#39004C', 209: '#42264C', 210: '#FF00FF', 211: '#FF7FFF', 212: '#CC00CC', 213: '#CC66CC',
        214: '#990099', 215: '#994C99', 216: '#7F007F', 217: '#7F3F7F', 218: '#4C004C', 219: '#4C264C',
        220: '#FF00BF', 221: '#FF7FDF', 222: '#CC0099', 223: '#CC66B2', 224: '#990072', 225: '#994C85',
        226: '#7F005F', 227: '#7F3F6F', 228: '#4C0039', 229: '#4C2642', 230: '#FF007F', 231: '#FF7FBF',
        232: '#CC0066', 233: '#CC6699', 234: '#99004C', 235: '#994C72', 236: '#7F003F', 237: '#7F3F5F',
        238: '#4C0026', 239: '#4C2639', 240: '#FF003F', 241: '#FF7F9F', 242: '#CC0032', 243: '#CC667F',
        244: '#990026', 245: '#994C5F', 246: '#7F001F', 247: '#7F3F4F', 248: '#4C0013', 249: '#4C262F',
        250: '#333333', 251: '#505050', 252: '#696969', 253: '#828282', 254: '#BEBEBE', 255: '#FFFFFF',
        256: '#000000', // ByLayer - æœƒä½¿ç”¨åœ–å±¤é¡è‰²
      };

      /**
       * å°‡ AutoCAD é¡è‰²ç·¨è™Ÿ (ACI) è½‰æ›ç‚º HEX é¡è‰²ç¢¼
       * @param {number} aciColor - AutoCAD é¡è‰²ç·¨è™Ÿ (0-256)
       * @returns {string} - HEX é¡è‰²ç¢¼ï¼Œä¾‹å¦‚ '#FF0000'
       */
      function aciToHex(aciColor) {
        if (aciColor === undefined || aciColor === null) {
          return '#808080'; // é è¨­ç°è‰²
        }
        // ç¢ºä¿æ˜¯æ•¸å­—
        const colorNum = parseInt(aciColor);
        if (isNaN(colorNum) || colorNum < 0 || colorNum > 256) {
          return '#808080'; // ç„¡æ•ˆé¡è‰²è¿”å›ç°è‰²
        }
        return ACI_COLORS[colorNum] || '#808080';
      }

      // Canvas ç›¸é—œ
      const canvas = document.getElementById("mainCanvas");
      const ctx = canvas.getContext("2d");
      const container = document.getElementById("canvasContainer");

      // ==================== åˆå§‹åŒ– ====================
      function init() {
        resizeCanvas();
        setupEventListeners();
        render();
        loadDefaultCategories();
      }

      function resizeCanvas() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        render();
      }

      function loadDefaultCategories() {
        // é è¨­ç‰†é¡å‹
        state.categories = [
          {
            id: 1,
            code: "EXT",
            name: "å¤–ç‰†",
            heightType: "æ¨“é«˜-æ¢æ·±",
            color: "#E74C3C",
          },
          {
            id: 2,
            code: "INT",
            name: "å…§ç‰†",
            heightType: "æ¨“é«˜-æ¢æ·±",
            color: "#3498DB",
          },
          {
            id: 3,
            code: "RC",
            name: "RCç‰†",
            heightType: "åŒæ¨“é«˜",
            color: "#2ECC71",
          },
          {
            id: 4,
            code: "PART",
            name: "è¼•éš”é–“",
            heightType: "æ¨“é«˜-æ¢æ·±",
            color: "#F1C40F",
          },
          {
            id: 5,
            code: "BALC",
            name: "é™½å°ç‰†",
            heightType: "1.2m",
            color: "#9B59B6",
          },
          {
            id: 6,
            code: "PARAPET",
            name: "å¥³å…’ç‰†",
            heightType: "1.5m",
            color: "#E67E22",
          },
        ];
        updateCategoryList();
        updateCategoryFilter();
      }

      // ==================== äº‹ä»¶ç›£è½ ====================
      function setupEventListeners() {
        // è¦–çª—å¤§å°æ”¹è®Š
        window.addEventListener("resize", resizeCanvas);

        // æª”æ¡ˆä¸Šå‚³
        document.getElementById("uploadBtn").addEventListener("click", () => {
          document.getElementById("fileInput").click();
        });
        document
          .getElementById("fileInput")
          .addEventListener("change", handleFileSelect);

        // é¸æ“‡åœ–å±¤æŒ‰éˆ•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const selectLayersBtn = document.getElementById("selectLayersBtn");
        if (selectLayersBtn) {
          selectLayersBtn.addEventListener("click", openLayerSelectionModal);
        }

        // åŒ¯å‡º CSV æŒ‰éˆ•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const exportCsvBtn = document.getElementById("exportCsvBtn");
        if (exportCsvBtn) {
          exportCsvBtn.addEventListener("click", exportCsv);
        }

        // ç•«å¸ƒå·¥å…·
        document.querySelectorAll(".canvas-tool-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const tool = btn.dataset.tool;
            if (tool === "zoom-in") zoomIn();
            else if (tool === "zoom-out") zoomOut();
            else if (tool === "fit") zoomFit();
            else selectTool(tool);
          });
        });

        // é¢æ¿åˆ‡æ›
        document.querySelectorAll(".panel-tab").forEach((tab) => {
          tab.addEventListener("click", () => switchPanel(tab.dataset.panel));
        });

        // å´é‚Šæ¬„æ‘ºç–Šåˆ‡æ›
        const sidebarToggle = document.getElementById("sidebarToggle");
        const sidebarLeft = document.getElementById("sidebarLeft");
        if (sidebarToggle && sidebarLeft) {
          // é è¨­ç‚ºæ”¶åˆç‹€æ…‹
          sidebarLeft.classList.add("collapsed");
          
          sidebarToggle.addEventListener("click", () => {
            sidebarLeft.classList.toggle("collapsed");
            // æ‘ºç–Šå¾Œéœ€è¦é‡æ–°èª¿æ•´ Canvas å¤§å°
            setTimeout(() => {
              resizeCanvas();
            }, 300);
          });
        }

        // Canvas äº‹ä»¶
        // mousedown ç¶å®šåˆ° canvasï¼ˆè¦åœ¨ canvas ä¸Šé–‹å§‹æ‹–æ›³ï¼‰
        canvas.addEventListener("mousedown", handleMouseDown);
        // mousemove å’Œ mouseup ç¶å®šåˆ° documentï¼ˆæ‹–æ›³æ™‚æ»‘é¼ å¯èƒ½é›¢é–‹ canvasï¼‰
        document.addEventListener("mousemove", handleMouseMove);
        document.addEventListener("mouseup", handleMouseUp);
        // ä½¿ç”¨ passive: false ä»¥ç¢ºä¿å¯ä»¥æ­£ç¢ºé˜»æ­¢é è¨­æ»¾å‹•è¡Œç‚º
        canvas.addEventListener("wheel", handleWheel, { passive: false });
        canvas.addEventListener("contextmenu", (e) => e.preventDefault());
        
        // ç•¶æ»‘é¼ é›¢é–‹ canvas æ™‚ï¼Œå¦‚æœä¸æ˜¯åœ¨æ‹–æ›³ç‹€æ…‹å‰‡é‡ç½®æ¸¸æ¨™
        canvas.addEventListener("mouseleave", () => {
          if (!state.isDragging && !state.isMiddleMousePanning) {
            canvas.style.cursor = state.currentTool === "pan" ? "grab" : "default";
          }
        });
        
        // é˜»æ­¢ä¸­éµé»æ“Šçš„é è¨­è‡ªå‹•æ»¾å‹•è¡Œç‚º
        canvas.addEventListener("auxclick", (e) => {
          if (e.button === 1) {
            e.preventDefault();
          }
        });
        // é¡å¤–é˜»æ­¢ mousedown ä¸­éµçš„é è¨­è¡Œç‚ºï¼ˆéƒ¨åˆ†ç€è¦½å™¨éœ€è¦ï¼‰
        canvas.addEventListener("mousedown", (e) => {
          if (e.button === 1) {
            e.preventDefault();
          }
        });

        // éµç›¤å¿«æ·éµ
        document.addEventListener("keydown", handleKeyDown);
      }

      // ==================== æª”æ¡ˆè™•ç† ====================
      async function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (!file.name.toLowerCase().endsWith(".dxf")) {
          alert("è«‹é¸æ“‡ DXF æª”æ¡ˆ");
          return;
        }

        const statusEl = document.getElementById("fileStatus");
        const infoEl = document.getElementById("infoText");

        try {
          // æ­¥é©Ÿ 1: ä¸Šå‚³æª”æ¡ˆ
          statusEl.textContent = "ä¸Šå‚³ä¸­...";
          infoEl.textContent = "ä¸Šå‚³ DXF æª”æ¡ˆ...";

          const formData = new FormData();
          formData.append("file", file);

          const uploadResp = await fetch("http://localhost:5000/api/upload", {
            method: "POST",
            body: formData,
          });

          if (!uploadResp.ok) {
            throw new Error("ä¸Šå‚³å¤±æ•—");
          }

          const uploadData = await uploadResp.json();
          console.log("ä¸Šå‚³æˆåŠŸ:", uploadData);

          // æ­¥é©Ÿ 2: è§£æ DXF
          statusEl.textContent = "è§£æä¸­...";
          infoEl.textContent = "è§£æ DXF æª”æ¡ˆï¼ˆé€™å¯èƒ½éœ€è¦ 1-3 åˆ†é˜ï¼‰...";

          const parseResp = await fetch("http://localhost:5000/api/parse", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              filepath: uploadData.filepath,
              project_name: file.name,
            }),
          });

          if (!parseResp.ok) {
            throw new Error("è§£æå¤±æ•—");
          }

          const parseData = await parseResp.json();
          console.log("è§£ææˆåŠŸ:", parseData);

          // æ­¥é©Ÿ 3: é¡¯ç¤ºçµæœ
          displayDxfData(parseData, file.name);

          statusEl.textContent = `å·²è¼‰å…¥: ${file.name}`;
          infoEl.textContent = `å…± ${parseData.total_segment_count.toLocaleString()} æ¢ç·šæ®µ, ${
            Object.keys(parseData.layers).length
          } å€‹åœ–å±¤`;

          alert(
            `è¼‰å…¥æˆåŠŸï¼\nç·šæ®µæ•¸: ${parseData.total_segment_count.toLocaleString()}\nåœ–å±¤æ•¸: ${
              Object.keys(parseData.layers).length
            }`
          );
        } catch (error) {
          console.error("éŒ¯èª¤:", error);
          alert("è™•ç†å¤±æ•—: " + error.message);
          statusEl.textContent = "æœªé¸æ“‡æª”æ¡ˆ";
          infoEl.textContent = "ç­‰å¾…ä¸Šå‚³ DXF æª”æ¡ˆ...";
        }
      }

      // é¡¯ç¤º DXF è³‡æ–™
      function displayDxfData(data, filename) {
        // æ›´æ–°å³å´çµ±è¨ˆé¢æ¿
        document.getElementById("fileName").textContent = filename;
        document.getElementById("layerCountInfo").textContent = Object.keys(
          data.layers
        ).length;
        document.getElementById("segmentCountInfo").textContent =
          data.total_segment_count.toLocaleString();

        // è¨ˆç®—å„åœ–å±¤çµ±è¨ˆ
        const layerStats = {};
        data.segments.forEach((seg) => {
          const layer = seg.layer;
          if (!layerStats[layer]) {
            layerStats[layer] = { count: 0, length: 0 };
          }
          layerStats[layer].count++;
          layerStats[layer].length += seg.length;
        });

        // å„²å­˜åœ–å±¤é¡è‰²å°æ‡‰è¡¨
        state.layerColors = {};
        Object.entries(data.layers).forEach(([layerName, layerInfo]) => {
          // å°‡ ACI é¡è‰²è½‰æ›ç‚º HEX é¡è‰²
          state.layerColors[layerName] = aciToHex(layerInfo.color);
        });
        console.log("å·²è¼‰å…¥åœ–å±¤é¡è‰²", Object.keys(state.layerColors).length, "å€‹");

        // æŒ‰ç·šæ®µæ•¸æ’åºï¼Œå–å‰ 20 å
        const sorted = Object.entries(layerStats)
          .sort((a, b) => b[1].count - a[1].count)
          .slice(0, 20);

        // æ›´æ–°çµ±è¨ˆè¡¨æ ¼ï¼ˆåŠ å…¥é¡è‰²æŒ‡ç¤ºï¼‰
        const tbody = document.querySelector("#summaryTable tbody");
        tbody.innerHTML = sorted
          .map(
            ([layer, stats]) => {
              const color = state.layerColors[layer] || '#888888';
              return `<tr>
                    <td><span style="display:inline-block;width:12px;height:12px;background:${color};border-radius:2px;margin-right:6px;vertical-align:middle;"></span>${layer}</td>
                    <td>${stats.count.toLocaleString()}</td>
                    <td>${(stats.length / 1000).toFixed(2)}</td>
                </tr>`;
            }
          )
          .join("");

        // æ›´æ–°å·¦å´åœ–å±¤åˆ—è¡¨ï¼ˆåŠ å…¥é¡è‰²æŒ‡ç¤ºï¼‰
        document.getElementById("layerCount").textContent = `${
          Object.keys(data.layers).length
        } å€‹åœ–å±¤`;
        const layerList = document.getElementById("layerList");
        
        // åˆå§‹åŒ–åœ–å±¤å¯è¦‹æ€§ï¼ˆé è¨­å…¨éƒ¨é¡¯ç¤ºï¼‰- ä½¿ç”¨æ‰€æœ‰åœ–å±¤
        state.layerVisibility = {};
        const allLayers = Object.keys(data.layers);
        allLayers.forEach(layerName => {
          state.layerVisibility[layerName] = true;
        });
        
        // æŒ‰åç¨±æ’åºåœ–å±¤
        const sortedLayers = allLayers.sort((a, b) => a.localeCompare(b));
        
        layerList.innerHTML = sortedLayers
          .map(layer => {
              const color = state.layerColors[layer] || '#888888';
              const isVisible = state.layerVisibility[layer] !== false;
              return `<div class="layer-item" data-layer="${layer}" style="padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 12px; display: flex; align-items: center; justify-content: space-between; opacity: ${isVisible ? 1 : 0.5};">
                      <div style="display: flex; align-items: center; flex: 1; min-width: 0;">
                        <span style="display:inline-block;width:12px;height:12px;background:${color};border-radius:2px;margin-right:6px;flex-shrink:0;"></span>
                        <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${layer}">${layer}</span>
                      </div>
                      <button class="layer-toggle-btn" data-layer="${layer}" title="${isVisible ? 'éš±è—' : 'é¡¯ç¤º'}" style="background:none;border:none;cursor:pointer;font-size:14px;padding:0 4px;opacity:${isVisible ? 1 : 0.3};">
                        ${isVisible ? 'ğŸ‘ï¸' : 'ğŸš«'}
                      </button>
                </div>`;
            })
          .join("");
        
        // ç¶å®šåœ–å±¤åˆ‡æ›äº‹ä»¶
        layerList.querySelectorAll('.layer-toggle-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const layerName = btn.dataset.layer;
            state.layerVisibility[layerName] = !state.layerVisibility[layerName];
            const isVisible = state.layerVisibility[layerName];
            btn.textContent = isVisible ? 'ğŸ‘ï¸' : 'ğŸš«';
            btn.style.opacity = isVisible ? 1 : 0.3;
            btn.title = isVisible ? 'éš±è—' : 'é¡¯ç¤º';
            const layerItem = btn.closest('.layer-item');
            if (layerItem) {
              layerItem.style.opacity = isVisible ? 1 : 0.5;
            }
            console.log('[Layer Toggle]', layerName, isVisible ? 'ON' : 'OFF');
            render();
          });
        });

        // è½‰æ›ç·šæ®µè³‡æ–™æ ¼å¼ä¸¦å„²å­˜åˆ° state
        // æ³¨æ„ï¼šä¿ç•™é ‚é»è³‡è¨Šä»¥æ­£ç¢ºç¹ªè£½å¤šæ®µç·š
        state.segments = data.segments.map((seg, index) => ({
          id: index + 1,
          layer: seg.layer,
          startX: seg.start_point[0],
          startY: seg.start_point[1],
          endX: seg.end_point[0],
          endY: seg.end_point[1],
          length: seg.length,
          vertices: seg.vertices || null, // ä¿ç•™å¤šæ®µç·šé ‚é»
          entityType: seg.entity_type || 'LINE', // ä¿ç•™å¯¦é«”é¡å‹
          categoryId: null, // å°šæœªåˆ†é¡
        }));

        console.log("å·²è¼‰å…¥", state.segments.length, "æ¢ç·šæ®µ");

        // è‡ªå‹•ç¸®æ”¾ä»¥é©åˆè¦–çª—
        zoomFit();
      }

      async function simulateFileProcessing(file) {
        // æ¨¡æ“¬ API è™•ç†å»¶é²
        await new Promise((resolve) => setTimeout(resolve, 1000));

        // è¼‰å…¥ç¤ºç¯„è³‡æ–™
        state.buildings = [
          { id: 1, name: "Aæ£Ÿ" },
          { id: 2, name: "Bæ£Ÿ" },
          { id: 3, name: "åœ°ä¸‹å±¤ï¼ˆå…±ç”¨ï¼‰" },
        ];

        state.floors = [
          { id: 1, buildingId: 1, name: "1F" },
          { id: 2, buildingId: 1, name: "2~5F" },
          { id: 3, buildingId: 1, name: "6F" },
          { id: 4, buildingId: 1, name: "RF" },
          { id: 5, buildingId: 2, name: "1F" },
          { id: 6, buildingId: 2, name: "2~8F" },
          { id: 7, buildingId: 2, name: "RF" },
          { id: 8, buildingId: 3, name: "B1F" },
          { id: 9, buildingId: 3, name: "B2F" },
        ];

        // ç”Ÿæˆç¤ºç¯„ç·šæ®µ
        state.segments = generateDemoSegments();

        updateBuildingList();
        updateBuildingFilter();
        updateSummary();
        render();
      }

      function generateDemoSegments() {
        const segments = [];
        let id = 1;

        // å¤–ç‰†ï¼ˆç´…è‰²çŸ©å½¢ï¼‰
        const walls = [
          { x1: 0, y1: 0, x2: 15000, y2: 0, cat: 1 },
          { x1: 15000, y1: 0, x2: 15000, y2: 10000, cat: 1 },
          { x1: 15000, y1: 10000, x2: 0, y2: 10000, cat: 1 },
          { x1: 0, y1: 10000, x2: 0, y2: 0, cat: 1 },
          // å…§ç‰†
          { x1: 5000, y1: 0, x2: 5000, y2: 7000, cat: 2 },
          { x1: 10000, y1: 0, x2: 10000, y2: 10000, cat: 2 },
          { x1: 0, y1: 5000, x2: 10000, y2: 5000, cat: 2 },
          // RCç‰†
          { x1: 5000, y1: 7000, x2: 5000, y2: 10000, cat: 3 },
          // è¼•éš”é–“
          { x1: 2500, y1: 0, x2: 2500, y2: 5000, cat: 4 },
          { x1: 7500, y1: 0, x2: 7500, y2: 5000, cat: 4 },
          // é™½å°ç‰†
          { x1: 15000, y1: 3000, x2: 17000, y2: 3000, cat: 5 },
          { x1: 17000, y1: 3000, x2: 17000, y2: 7000, cat: 5 },
          { x1: 17000, y1: 7000, x2: 15000, y2: 7000, cat: 5 },
        ];

        walls.forEach((w) => {
          const length = Math.sqrt((w.x2 - w.x1) ** 2 + (w.y2 - w.y1) ** 2);
          segments.push({
            id: id,
            uid: `seg_${String(id).padStart(5, "0")}`,
            layer: `A-WALL-${
              state.categories.find((c) => c.id === w.cat)?.code || "UNKNOWN"
            }`,
            categoryId: w.cat,
            buildingId: 1,
            floorId: 1,
            startX: w.x1,
            startY: w.y1,
            endX: w.x2,
            endY: w.y2,
            length: length,
          });
          id++;
        });

        return segments;
      }

      // ==================== ç¹ªåœ–åŠŸèƒ½ ====================
      
      // æ ¹æ“šæ¢ä»¶éæ¿¾ç·šæ®µï¼ˆåœ–å±¤å¯è¦‹æ€§ç­‰ï¼‰
      function getFilteredSegments() {
        const result = state.segments.filter(seg => {
          // æª¢æŸ¥åœ–å±¤å¯è¦‹æ€§ - åªæœ‰æ˜ç¢ºç‚º true æ™‚æ‰é¡¯ç¤º
          const isVisible = state.layerVisibility[seg.layer];
          if (isVisible === false) {
            return false;
          }
          return true;
        });
        return result;
      }
      
      function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç¹ªè£½èƒŒæ™¯
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ç¹ªè£½ç¶²æ ¼
        if (state.showGrid) {
          drawGrid();
        }

        // ç¹ªè£½æ‰€æœ‰ç·šæ®µ
        const filteredSegments = getFilteredSegments();
        filteredSegments.forEach((seg) => {
          drawSegment(seg, state.selectedSegments.includes(seg));
        });
      }

      function drawGrid() {
        const gridSize = 1000 * state.zoom; // 1m ç¶²æ ¼

        ctx.strokeStyle = "#f0f0f0";
        ctx.lineWidth = 1;
        ctx.beginPath();

        // è¨ˆç®—å¯è¦‹ç¯„åœ
        const startX = Math.floor(-state.panX / gridSize) * gridSize;
        const startY = Math.floor(-state.panY / gridSize) * gridSize;

        for (let x = startX; x < canvas.width - state.panX; x += gridSize) {
          const screenX = x + state.panX;
          ctx.moveTo(screenX, 0);
          ctx.lineTo(screenX, canvas.height);
        }

        for (let y = startY; y < canvas.height - state.panY; y += gridSize) {
          const screenY = canvas.height - (y + state.panY);
          ctx.moveTo(0, screenY);
          ctx.lineTo(canvas.width, screenY);
        }

        ctx.stroke();
      }

      function drawSegment(seg, isSelected) {
        // å„ªå…ˆä½¿ç”¨åˆ†é¡é¡è‰²ï¼Œå…¶æ¬¡ä½¿ç”¨åœ–å±¤åŸå§‹é¡è‰²
        const category = state.categories.find((c) => c.id === seg.categoryId);
        let color;
        if (category) {
          color = category.color;
        } else if (state.layerColors && state.layerColors[seg.layer]) {
          color = state.layerColors[seg.layer];
        } else {
          color = "#808080"; // é è¨­ç°è‰²
        }

        // è¨­å®šç¹ªåœ–æ¨£å¼
        ctx.strokeStyle = color;
        ctx.lineWidth = isSelected ? 2 : 1; // æ¸›å°‘ç·šå¯¬è®“åœ–é¢æ›´æ¸…æ™°
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        if (isSelected) {
          // é¸å–é«˜äº®
          ctx.shadowColor = color;
          ctx.shadowBlur = 6;
          ctx.lineWidth = 3;
        }

        ctx.beginPath();

        // æª¢æŸ¥æ˜¯å¦æœ‰å¤šæ®µç·šé ‚é»
        if (seg.vertices && seg.vertices.length >= 2) {
          // ç¹ªè£½å¤šæ®µç·š
          for (let i = 0; i < seg.vertices.length; i++) {
            const vx = (seg.vertices[i][0] * state.zoom) / 1000 + state.panX;
            const vy = canvas.height - ((seg.vertices[i][1] * state.zoom) / 1000 + state.panY);
            if (i === 0) {
              ctx.moveTo(vx, vy);
            } else {
              ctx.lineTo(vx, vy);
            }
          }
        } else {
          // ç¹ªè£½ç°¡å–®ç·šæ®µ
          const x1 = (seg.startX * state.zoom) / 1000 + state.panX;
          const y1 = canvas.height - ((seg.startY * state.zoom) / 1000 + state.panY);
          const x2 = (seg.endX * state.zoom) / 1000 + state.panX;
          const y2 = canvas.height - ((seg.endY * state.zoom) / 1000 + state.panY);
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
        }

        ctx.stroke();
        ctx.shadowBlur = 0;
      }

      function getFilteredSegments() {
        let filtered = state.segments;

        const buildingFilter = document.getElementById("buildingFilter");
        const floorFilter = document.getElementById("floorFilter");
        const categoryFilter = document.getElementById("categoryFilter");

        if (buildingFilter && buildingFilter.value) {
          filtered = filtered.filter(
            (s) => s.buildingId === parseInt(buildingFilter.value)
          );
        }
        if (floorFilter && floorFilter.value) {
          filtered = filtered.filter(
            (s) => s.floorId === parseInt(floorFilter.value)
          );
        }
        if (categoryFilter && categoryFilter.value) {
          filtered = filtered.filter(
            (s) => s.categoryId === parseInt(categoryFilter.value)
          );
        }

        return filtered;
      }

      // ==================== æ»‘é¼ äº‹ä»¶ ====================
      // ã€å„ªåŒ–ã€‘é¡ä¼¼ AutoCAD çš„æ“ä½œæ–¹å¼ï¼š
      // - æ»¾è¼ªï¼šå¹³ç§»ç•«å¸ƒï¼ˆä¸Šä¸‹å·¦å³ç§»å‹•ï¼‰
      // - Ctrl + æ»¾è¼ªï¼šç¸®æ”¾ç•«å¸ƒ
      // - ä¸­éµæ‹–æ›³ï¼šå¹³ç§»ç•«å¸ƒ
      // - å³éµæ‹–æ›³ï¼šå¹³ç§»ç•«å¸ƒ
      // - å·¦éµï¼šé¸å–ç·šæ®µ

      function handleMouseDown(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // å¦‚æœå·²ç¶“åœ¨æ‹–æ›³ä¸­ï¼Œå¿½ç•¥å…¶ä»–æ»‘é¼ æŒ‰éˆ•äº‹ä»¶ï¼ˆé˜²æ­¢è¡çªï¼‰
        if (state.isMiddleMousePanning || state.isDragging) {
          return;
        }

        // ä¸­éµæ‹–æ›³å¹³ç§»ï¼ˆé¡ä¼¼ AutoCADï¼‰
        if (e.button === 1) {
          console.log('[Canvas] Middle-click pan start');
          e.preventDefault();
          state.isMiddleMousePanning = true;
          state.middleMouseStart = {
            x: e.clientX,
            y: e.clientY,
            panX: state.panX,
            panY: state.panY,
          };
          canvas.style.cursor = "grabbing";
          return;
        }

        // å³éµæ‹–æ›³å¹³ç§»ï¼ˆä½¿ç”¨èˆ‡ä¸­éµç›¸åŒçš„è¨ˆç®—æ–¹å¼ï¼‰
        if (e.button === 2 || state.currentTool === "pan") {
          console.log('[Canvas] Right-click/Pan tool drag start');
          state.isDragging = true;
          state.dragStart = {
            x: e.clientX,
            y: e.clientY,
            panX: state.panX,
            panY: state.panY,
          };
          canvas.style.cursor = "grabbing";
        } else if (state.currentTool === "select") {
          const clicked = findSegmentAtPoint(x, y);
          if (clicked) {
            if (e.shiftKey) {
              const idx = state.selectedSegments.indexOf(clicked);
              if (idx >= 0) {
                state.selectedSegments.splice(idx, 1);
              } else {
                state.selectedSegments.push(clicked);
              }
            } else {
              state.selectedSegments = [clicked];
            }
          } else {
            state.selectedSegments = [];
          }
          updatePropertiesPanel();
          render();
        }
      }

      function handleMouseMove(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // æ›´æ–°åº§æ¨™é¡¯ç¤º
        const worldX = (((x - state.panX) / state.zoom) * 1000).toFixed(0);
        const worldY = (
          ((canvas.height - y - state.panY) / state.zoom) *
          1000
        ).toFixed(0);
        document.getElementById(
          "statusRight"
        ).textContent = `åº§æ¨™: ${worldX}, ${worldY} | ç¸®æ”¾: ${Math.round(
          state.zoom * 100
        )}%`;

        // ä¸­éµæ‹–æ›³å¹³ç§»
        if (state.isMiddleMousePanning) {
          const dx = e.clientX - state.middleMouseStart.x;
          const dy = e.clientY - state.middleMouseStart.y;
          state.panX = state.middleMouseStart.panX + dx;
          state.panY = state.middleMouseStart.panY - dy; // æ³¨æ„ Y è»¸æ–¹å‘åè½‰
          render();
          return;
        }

        // å³éµæ‹–æ›³å¹³ç§»ï¼ˆä½¿ç”¨èˆ‡ä¸­éµç›¸åŒçš„å¢é‡å¼è¨ˆç®—ï¼‰
        if (state.isDragging) {
          const dx = e.clientX - state.dragStart.x;
          const dy = e.clientY - state.dragStart.y;
          state.panX = state.dragStart.panX + dx;
          state.panY = state.dragStart.panY - dy; // Y è»¸æ–¹å‘åè½‰ï¼ˆå’Œä¸­éµä¸€è‡´ï¼‰
          render();
        }
      }

      function handleMouseUp(e) {
        // çµæŸä»»ä½•æ‹–æ›³ç‹€æ…‹ï¼ˆçµ±ä¸€é‡ç½®ï¼‰
        if (state.isMiddleMousePanning) {
          state.isMiddleMousePanning = false;
        }
        if (state.isDragging) {
          state.isDragging = false;
        }
        canvas.style.cursor = state.currentTool === "pan" ? "grab" : "default";
      }

      function handleWheel(e) {
        e.preventDefault();

        // å¦‚æœæ­£åœ¨æ‹–æ›³ä¸­ï¼Œå¿½ç•¥æ»¾è¼ªäº‹ä»¶ï¼ˆé˜²æ­¢è¡çªï¼‰
        if (state.isMiddleMousePanning || state.isDragging) {
          return;
        }

        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // ã€æ“ä½œæ–¹å¼ã€‘æ»¾è¼ªï¼šç¸®æ”¾ï¼›ä¸­éµæ‹–æ›³ï¼šå¹³ç§»
        // Shift + æ»¾è¼ªï¼šæ°´å¹³å¹³ç§»ï¼ˆå¯é¸ï¼‰
        if (e.shiftKey) {
          console.log('[Canvas] Shift+Wheel horizontal pan, deltaY:', e.deltaY);
          // Shift + æ»¾è¼ªï¼šæ°´å¹³å¹³ç§»
          const panSpeed = 50;
          state.panX -= e.deltaY > 0 ? panSpeed : -panSpeed;
        } else {
          // æ»¾è¼ªç¸®æ”¾ï¼ˆä»¥æ»‘é¼ ä½ç½®ç‚ºä¸­å¿ƒï¼‰- ç„¡é™ç¸®æ”¾
          console.log('[Canvas] Wheel zoom, deltaY:', e.deltaY);
          const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
          // ç„¡é™ç¸®æ”¾ï¼šåªè¨­æ¥µå°çš„ä¸‹é™é¿å…æ•¸å­¸éŒ¯èª¤ï¼Œç„¡ä¸Šé™
          const newZoom = Math.max(0.0001, state.zoom * zoomFactor);

          // è¨ˆç®—ç¸®æ”¾å¾Œçš„å¹³ç§»åç§»ï¼Œä¿æŒæ»‘é¼ ä½ç½®ä¸è®Š
          state.panX = mouseX - (mouseX - state.panX) * (newZoom / state.zoom);
          state.panY =
            canvas.height -
            mouseY -
            (canvas.height - mouseY - state.panY) * (newZoom / state.zoom);
          state.zoom = newZoom;
        }

        render();

        // æ›´æ–°åº§æ¨™é¡¯ç¤º
        const worldX = (((mouseX - state.panX) / state.zoom) * 1000).toFixed(0);
        const worldY = (
          ((canvas.height - mouseY - state.panY) / state.zoom) *
          1000
        ).toFixed(0);
        document.getElementById(
          "statusRight"
        ).textContent = `åº§æ¨™: ${worldX}, ${worldY} | ç¸®æ”¾: ${Math.round(
          state.zoom * 100
        )}%`;
      }

      function handleKeyDown(e) {
        if (e.ctrlKey && e.key === "f") {
          e.preventDefault();
          openSearch();
        }
        if (e.key === "Escape") {
          state.selectedSegments = [];
          updatePropertiesPanel();
          render();
        }
      }

      function findSegmentAtPoint(x, y) {
        const threshold = 8;
        const filtered = getFilteredSegments();

        for (const seg of filtered) {
          const x1 = (seg.startX * state.zoom) / 1000 + state.panX;
          const y1 =
            canvas.height - ((seg.startY * state.zoom) / 1000 + state.panY);
          const x2 = (seg.endX * state.zoom) / 1000 + state.panX;
          const y2 =
            canvas.height - ((seg.endY * state.zoom) / 1000 + state.panY);

          const dist = distanceToLineSegment(x, y, x1, y1, x2, y2);
          if (dist < threshold) {
            return seg;
          }
        }
        return null;
      }

      function distanceToLineSegment(px, py, x1, y1, x2, y2) {
        const dx = x2 - x1;
        const dy = y2 - y1;
        const lengthSq = dx * dx + dy * dy;

        if (lengthSq === 0) {
          return Math.sqrt((px - x1) ** 2 + (py - y1) ** 2);
        }

        let t = Math.max(
          0,
          Math.min(1, ((px - x1) * dx + (py - y1) * dy) / lengthSq)
        );
        const projX = x1 + t * dx;
        const projY = y1 + t * dy;

        return Math.sqrt((px - projX) ** 2 + (py - projY) ** 2);
      }

      // ==================== å·¥å…·æ“ä½œ ====================
      function selectTool(tool) {
        state.currentTool = tool;
        document.querySelectorAll(".canvas-tool-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.tool === tool);
        });
        canvas.style.cursor = tool === "pan" ? "grab" : "default";
      }

      function zoomIn() {
        state.zoom = Math.min(10, state.zoom * 1.2);
        render();
      }

      function zoomOut() {
        state.zoom = Math.max(0.1, state.zoom / 1.2);
        render();
      }

      function zoomFit() {
        if (state.segments.length === 0) return;

        let minX = Infinity,
          minY = Infinity,
          maxX = -Infinity,
          maxY = -Infinity;

        state.segments.forEach((seg) => {
          minX = Math.min(minX, seg.startX, seg.endX);
          minY = Math.min(minY, seg.startY, seg.endY);
          maxX = Math.max(maxX, seg.startX, seg.endX);
          maxY = Math.max(maxY, seg.startY, seg.endY);
        });

        const width = (maxX - minX) / 1000;
        const height = (maxY - minY) / 1000;
        const padding = 50;

        state.zoom = Math.min(
          (canvas.width - padding * 2) / width,
          (canvas.height - padding * 2) / height
        );
        state.zoom = Math.max(0.1, Math.min(10, state.zoom));

        state.panX = padding - (minX * state.zoom) / 1000;
        state.panY = padding - (minY * state.zoom) / 1000;

        render();
      }

      function toggleGrid() {
        state.showGrid = !state.showGrid;
        document
          .getElementById("toggleGridBtn")
          .classList.toggle("active", state.showGrid);
        render();
      }

      function openSearch() {
        showNotification("æœå°‹åŠŸèƒ½é–‹ç™¼ä¸­", "info");
      }

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      }

      // ==================== UI æ›´æ–° ====================
      function updateBuildingList() {
        const list = document.getElementById("buildingList");

        if (state.buildings.length === 0) {
          list.innerHTML =
            '<div class="empty-state" style="padding: 20px;"><div style="font-size: 12px;">è«‹å…ˆä¸Šå‚³ DXF æª”æ¡ˆ</div></div>';
          return;
        }

        list.innerHTML = state.buildings
          .map(
            (b) => `
                <div class="tree-item ${
                  state.selectedBuilding === b.id ? "selected" : ""
                }"
                     onclick="selectBuilding(${b.id})">
                    <span class="icon">ğŸ¢</span>
                    <span>${b.name}</span>
                </div>
            `
          )
          .join("");
      }

      function updateFloorList() {
        const list = document.getElementById("floorList");

        if (!state.selectedBuilding) {
          list.innerHTML =
            '<div class="empty-state" style="padding: 20px;"><div style="font-size: 12px;">è«‹é¸æ“‡çµæ§‹ç‰©</div></div>';
          return;
        }

        const floors = state.floors.filter(
          (f) => f.buildingId === state.selectedBuilding
        );

        if (floors.length === 0) {
          list.innerHTML =
            '<div class="empty-state" style="padding: 20px;"><div style="font-size: 12px;">ç„¡æ¨“å±¤è³‡æ–™</div></div>';
          return;
        }

        list.innerHTML = floors
          .map(
            (f) => `
                <div class="tree-item ${
                  state.selectedFloor === f.id ? "selected" : ""
                }"
                     onclick="selectFloor(${f.id})">
                    <span class="icon">ğŸ“Š</span>
                    <span>${f.name}</span>
                </div>
            `
          )
          .join("");
      }

      function updateCategoryList() {
        const list = document.getElementById("categoryList");

        if (state.categories.length === 0) {
          list.innerHTML =
            '<div class="empty-state" style="padding: 20px;"><div style="font-size: 12px;">å°šæœªè¨­å®š</div></div>';
          return;
        }

        list.innerHTML = state.categories
          .map((cat) => {
            const count = state.segments.filter(
              (s) => s.categoryId === cat.id
            ).length;
            const length =
              state.segments
                .filter((s) => s.categoryId === cat.id)
                .reduce((sum, s) => sum + s.length, 0) / 1000;

            return `
                    <div class="category-item" onclick="filterByCategory(${
                      cat.id
                    })">
                        <div class="category-color" style="background: ${
                          cat.color
                        }"></div>
                        <div class="category-info">
                            <div class="category-name">${cat.name} (${
              cat.code
            })</div>
                            <div class="category-stats">${count} æ¢ Â· ${length.toFixed(
              2
            )} m</div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function updateBuildingFilter() {
        const select = document.getElementById("buildingFilter");
        select.innerHTML =
          '<option value="">å…¨éƒ¨</option>' +
          state.buildings
            .map((b) => `<option value="${b.id}">${b.name}</option>`)
            .join("");
      }

      function updateFloorFilter() {
        const select = document.getElementById("floorFilter");
        const buildingId = document.getElementById("buildingFilter").value;

        let floors = state.floors;
        if (buildingId) {
          floors = floors.filter((f) => f.buildingId === parseInt(buildingId));
        }

        select.innerHTML =
          '<option value="">å…¨éƒ¨</option>' +
          floors
            .map((f) => `<option value="${f.id}">${f.name}</option>`)
            .join("");
      }

      function updateCategoryFilter() {
        const select = document.getElementById("categoryFilter");
        select.innerHTML =
          '<option value="">å…¨éƒ¨</option>' +
          state.categories
            .map((c) => `<option value="${c.id}">${c.name}</option>`)
            .join("");
      }

      function updatePropertiesPanel() {
        const noSel = document.getElementById("noSelection");
        const props = document.getElementById("selectionProperties");

        if (state.selectedSegments.length === 0) {
          noSel.style.display = "block";
          props.style.display = "none";
          return;
        }

        noSel.style.display = "none";
        props.style.display = "block";

        const seg = state.selectedSegments[0];
        document.getElementById("propId").textContent = seg.uid;
        document.getElementById("propLayer").textContent = seg.layer;
        document.getElementById("propLength").textContent = `${(
          seg.length / 1000
        ).toFixed(3)} m`;

        // æ›´æ–°ä¸‹æ‹‰é¸å–®
        const buildingSelect = document.getElementById("propBuilding");
        buildingSelect.innerHTML =
          '<option value="">æœªæŒ‡å®š</option>' +
          state.buildings
            .map(
              (b) =>
                `<option value="${b.id}" ${
                  seg.buildingId === b.id ? "selected" : ""
                }>${b.name}</option>`
            )
            .join("");

        const floorSelect = document.getElementById("propFloor");
        const floors = state.floors.filter(
          (f) => !seg.buildingId || f.buildingId === seg.buildingId
        );
        floorSelect.innerHTML =
          '<option value="">æœªæŒ‡å®š</option>' +
          floors
            .map(
              (f) =>
                `<option value="${f.id}" ${
                  seg.floorId === f.id ? "selected" : ""
                }>${f.name}</option>`
            )
            .join("");

        const categorySelect = document.getElementById("propCategory");
        categorySelect.innerHTML =
          '<option value="">æœªåˆ†é¡</option>' +
          state.categories
            .map(
              (c) =>
                `<option value="${c.id}" ${
                  seg.categoryId === c.id ? "selected" : ""
                }>${c.name}</option>`
            )
            .join("");

        updateStatusBar();
      }

      function updateSummary() {
        const tbody = document.querySelector("#summaryTable tbody");

        if (state.categories.length === 0 || state.segments.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="3" class="empty-state">å°šç„¡è³‡æ–™</td></tr>';
          return;
        }

        let totalCount = 0;
        let totalLength = 0;

        const rows = state.categories
          .map((cat) => {
            const segs = state.segments.filter((s) => s.categoryId === cat.id);
            const count = segs.length;
            const length = segs.reduce((sum, s) => sum + s.length, 0) / 1000;

            totalCount += count;
            totalLength += length;

            return `
                    <tr>
                        <td><span style="display:inline-block;width:10px;height:10px;background:${
                          cat.color
                        };border-radius:2px;margin-right:6px;"></span>${
              cat.name
            }</td>
                        <td>${count}</td>
                        <td>${length.toFixed(2)}</td>
                    </tr>
                `;
          })
          .join("");

        tbody.innerHTML =
          rows +
          `
                <tr class="summary-total">
                    <td>ç¸½è¨ˆ</td>
                    <td>${totalCount}</td>
                    <td>${totalLength.toFixed(2)}</td>
                </tr>
            `;
      }

      function updateStatusBar() {
        const count = state.selectedSegments.length;
        if (count === 0) {
          document.getElementById("statusLeft").textContent = `å…± ${
            state.segments.length
          } æ¢ç·šæ®µ | ç¯©é¸é¡¯ç¤º ${getFilteredSegments().length} æ¢`;
        } else if (count === 1) {
          const seg = state.selectedSegments[0];
          document.getElementById("statusLeft").textContent = `å·²é¸å–: ${
            seg.uid
          } | é•·åº¦: ${(seg.length / 1000).toFixed(2)}m`;
        } else {
          const totalLength = state.selectedSegments.reduce(
            (sum, s) => sum + s.length,
            0
          );
          document.getElementById(
            "statusLeft"
          ).textContent = `å·²é¸å– ${count} æ¢ç·šæ®µ | ç¸½é•·åº¦: ${(
            totalLength / 1000
          ).toFixed(2)}m`;
        }
      }

      // ==================== é¸æ“‡æ“ä½œ ====================
      function selectBuilding(id) {
        state.selectedBuilding = id;
        state.selectedFloor = null;
        updateBuildingList();
        updateFloorList();
        document.getElementById("buildingFilter").value = id;
        updateFloorFilter();
        applyFilters();
      }

      function selectFloor(id) {
        state.selectedFloor = id;
        updateFloorList();
        document.getElementById("floorFilter").value = id;
        applyFilters();
      }

      function filterByCategory(categoryId) {
        document.getElementById("categoryFilter").value = categoryId;
        applyFilters();
      }

      function applyFilters() {
        updateFloorFilter();
        render();
        updateStatusBar();

        // æ›´æ–°æ¨™é¡Œ
        const building = state.buildings.find(
          (b) =>
            b.id === parseInt(document.getElementById("buildingFilter").value)
        );
        const floor = state.floors.find(
          (f) => f.id === parseInt(document.getElementById("floorFilter").value)
        );

        let title = "çµæ§‹å¹³é¢åœ–";
        if (building) title += ` - ${building.name}`;
        if (floor) title += ` ${floor.name}`;
        if (!building && !floor) title += " (æ‰€æœ‰æ¨“å±¤åˆä½µ)";

        document.getElementById("canvasTitle").textContent = title;
      }

      function applyProperties() {
        const buildingId = document.getElementById("propBuilding").value;
        const floorId = document.getElementById("propFloor").value;
        const categoryId = document.getElementById("propCategory").value;

        state.selectedSegments.forEach((seg) => {
          if (buildingId) seg.buildingId = parseInt(buildingId);
          if (floorId) seg.floorId = parseInt(floorId);
          if (categoryId) seg.categoryId = parseInt(categoryId);
        });

        updateCategoryList();
        updateSummary();
        render();
        showNotification("å±¬æ€§å·²æ›´æ–°", "success");
      }

      // ==================== é¢æ¿åˆ‡æ› ====================
      function switchPanel(panel) {
        document.querySelectorAll(".panel-tab").forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.panel === panel);
        });

        document.getElementById("propertiesPanel").style.display =
          panel === "properties" ? "block" : "none";
        document.getElementById("summaryPanel").style.display =
          panel === "summary" ? "block" : "none";
      }

      // ==================== Modal å°è©±æ¡† ====================
      function openCategoryModal() {
        document.getElementById("categoryModal").classList.add("show");
        renderCategoryForm();
      }

      function closeCategoryModal() {
        document.getElementById("categoryModal").classList.remove("show");
      }

      function renderCategoryForm() {
        const container = document.getElementById("categoryFormList");
        container.innerHTML = state.categories
          .map(
            (cat, idx) => `
                <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                    <input type="color" value="${cat.color}" data-idx="${idx}" class="cat-color" style="width: 40px; height: 36px; border: none; cursor: pointer;">
                    <input type="text" class="form-input cat-code" data-idx="${idx}" value="${cat.code}" placeholder="ä»£ç¢¼" style="width: 80px;">
                    <input type="text" class="form-input cat-name" data-idx="${idx}" value="${cat.name}" placeholder="åç¨±" style="flex: 1;">
                    <input type="text" class="form-input cat-height" data-idx="${idx}" value="${cat.heightType}" placeholder="é«˜åº¦é¡å‹" style="width: 100px;">
                    <button class="btn btn-outline" onclick="removeCategoryRow(${idx})" style="padding: 8px;">âœ•</button>
                </div>
            `
          )
          .join("");
      }

      function addCategoryRow() {
        state.categories.push({
          id: Date.now(),
          code: "",
          name: "",
          heightType: "",
          color: "#888888",
        });
        renderCategoryForm();
      }

      function removeCategoryRow(idx) {
        state.categories.splice(idx, 1);
        renderCategoryForm();
      }

      function saveCategories() {
        document.querySelectorAll(".cat-code").forEach((input, idx) => {
          state.categories[idx].code = input.value;
        });
        document.querySelectorAll(".cat-name").forEach((input, idx) => {
          state.categories[idx].name = input.value;
        });
        document.querySelectorAll(".cat-height").forEach((input, idx) => {
          state.categories[idx].heightType = input.value;
        });
        document.querySelectorAll(".cat-color").forEach((input, idx) => {
          state.categories[idx].color = input.value;
        });

        updateCategoryList();
        updateCategoryFilter();
        updateSummary();
        render();
        closeCategoryModal();
        showNotification("ç‰†é¡å‹å·²æ›´æ–°", "success");
      }

      function addBuilding() {
        state.structureModalMode = "building";
        document.getElementById("structureModalTitle").textContent =
          "æ–°å¢çµæ§‹ç‰©";
        document.getElementById("floorRangeGroup").style.display = "none";
        document.getElementById("structureName").value = "";
        document.getElementById("structureModal").classList.add("show");
      }

      function addFloor() {
        if (!state.selectedBuilding) {
          showNotification("è«‹å…ˆé¸æ“‡çµæ§‹ç‰©", "error");
          return;
        }
        state.structureModalMode = "floor";
        document.getElementById("structureModalTitle").textContent = "æ–°å¢æ¨“å±¤";
        document.getElementById("floorRangeGroup").style.display = "block";
        document.getElementById("structureName").value = "";
        document.getElementById("floorRange").value = "";
        document.getElementById("structureModal").classList.add("show");
      }

      function closeStructureModal() {
        document.getElementById("structureModal").classList.remove("show");
      }

      function saveStructure() {
        const name = document.getElementById("structureName").value.trim();
        if (!name) {
          showNotification("è«‹è¼¸å…¥åç¨±", "error");
          return;
        }

        if (state.structureModalMode === "building") {
          state.buildings.push({
            id: Date.now(),
            name: name,
          });
          updateBuildingList();
          updateBuildingFilter();
        } else {
          state.floors.push({
            id: Date.now(),
            buildingId: state.selectedBuilding,
            name: name,
          });
          updateFloorList();
          updateFloorFilter();
        }

        closeStructureModal();
        showNotification("å·²æ–°å¢", "success");
      }

      // ==================== åŒ¯å‡ºåŠŸèƒ½ ====================
      function exportExcel() {
        showNotification("åŒ¯å‡º Excel åŠŸèƒ½é–‹ç™¼ä¸­", "info");
      }

      function exportDxf() {
        showNotification("åŒ¯å‡º AutoCAD åŠŸèƒ½é–‹ç™¼ä¸­", "info");
      }

      function exportCsv() {
        showNotification("åŒ¯å‡º CSV åŠŸèƒ½é–‹ç™¼ä¸­", "info");
      }

      // ==================== åœ–å±¤é¸æ“‡åŠŸèƒ½ ====================
      function openLayerSelectionModal() {
        showNotification("åœ–å±¤é¸æ“‡åŠŸèƒ½é–‹ç™¼ä¸­", "info");
      }

      // ==================== è¼”åŠ©å‡½æ•¸ ====================
      function showLoading(show, text = "è™•ç†ä¸­...") {
        const overlay = document.getElementById("loading");
        overlay.querySelector(".loading-text").textContent = text;
        overlay.classList.toggle("show", show);
      }

      function showNotification(message, type = "info") {
        const notif = document.getElementById("notification");
        notif.textContent = message;
        notif.className = `notification ${type} show`;

        setTimeout(() => {
          notif.classList.remove("show");
        }, 3000);
      }

      // åˆå§‹åŒ–
      init();
    </script>
  </body>
</html>
